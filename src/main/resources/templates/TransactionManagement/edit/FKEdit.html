<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<script src="/erp/style/js/jquery.min.js"></script>
<script src="/erp/style/js/bootstrap.min.js"></script>
<link href="/erp/style/css/bootstrap.min.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" th:inline="javascript">
	//主页的项目名
	var path = $(window.parent.document.body).find("#path").val();

	//查询表格选择复选框监听
	$(function () {
        //除了表头（第一行）以外所有的行添加click事件.
		//已选择item页面  除了表头（第一行）以外所有的行添加click事件.
		$(document).on("click",".panel-infos tr",function(){
			var chks = $("input[type='checkbox']",this);
			var tag = $(this).attr("tag");
			if(tag=="selected"){
				// 之前已选中，设置为未选中
				$(this).attr("tag","");
				chks.prop("checked",false);
				$(this).css("backgroundColor", "#fff");
			}else{
				// 之前未选中，设置为选中
				$(this).attr("tag","selected");
				chks.prop("checked",true);
				$(this).css("backgroundColor", "#d0e9c6");
			}
		});

		//选择item页面 行绑定复选框
		$(document).on("click",".modal-body tr",function(){
			var chks = $("input[type='checkbox']",this);
			var tag = $(this).attr("tag");
			if(tag=="selected"){
				// 之前已选中，设置为未选中
				$(this).attr("tag","");
				chks.prop("checked",false);
				$(this).css("backgroundColor", "#fff");
			}else{
				// 之前未选中，设置为选中
				$(this).attr("tag","selected");
				chks.prop("checked",true);
				$(this).css("backgroundColor", "#d0e9c6");
			}
		});

	});

	//日期获取
	var end = "";
	var start = "";
	var now_month = "";
	window.onload = function(){
		var date = new Date();
		var year = date.getFullYear();
		var month = date.getMonth()+1;
		var day = date.getDate();
		if(month<10){
			month = "0"+month+""
		}
		if(day<10){
			day = "0"+day
		}
		now_month = year+"-"+month;
		end = year+"-"+month+"-"+day;
		start = year+"-"+month+"-01";
		//$(".form_date").val(start);
		$("input[name='billDate']").val(end);
		//$("input[name='billPeriod']").val(now_month);
		//document.getElementById('date_end').value = end;
		//document.getElementById('date_start').value = start;
	}

	$(function () {
		var date = new Date();
		var year = date.getFullYear();
		var month = date.getMonth() + 1;
		var day = date.getDate();
		if (month < 10) {
			month = "0" + month + ""
		}
		if (day < 10) {
			day = "0" + day
		}
		end = year + "-" + month + "-" + day;
		start = year + "-" + month + "-01";
		//$(".form_date").val(start);
		$("input[name='billDate']").val(end);
		//$("input[name='billPeriod']").val(now_month);
	});

	//页签切换
	function navcut(obj,infoid){
		//1.移除活动 隐藏模块
		$(".nav-tabs li").removeClass('active');
		$(".panel-infos").hide();
		//2.显示对象 显示模块
		$(obj).addClass('active');
		$("#"+infoid).show();
		
		if(infoid=="contact"){
			$("#btn-row").show();
		}else{
			$("#btn-row").hide();
		}
	}

	//删除行
	function del_row(obj){
		$(obj).parent().parent().remove();
		total();
	}
	
	//关闭拟态框 show hide
	function closemodal(modalid,kg){
		$("#"+modalid).modal(kg);
	}

	//表单效验
	function fromcheck(){
		//检测期间 billYearandPeriod
		/*if($("input[name='billYearandPeriod']").val() == ""){
			alert("请选择期间！");
			return false;
		}*/

		//检测名称
		if($("select[name='custId']").val() == -1){
			alert("请选择客户！");
			return false;
		}
		//是否有选择行检测
		if($(".num").size() == 0){
			alert("请选择产品！");
			return false;
		}
		//数量检测
		/*var trlens = gettrfid();
		for (id in trlens){
			if($("#qty_"+trlens[id]).val()<=0){
				alert("请输入数量！");
				$("#qty_"+trlens[id]).focus();
				return false;
			}
			if($("#stockId_"+trlens[id]).val()<0){
				alert("请选择仓库！");
				$("#stockId_"+trlens[id]).focus();
				return false;
			}
		}*/

		//提交表单
		var f = $("#f1").serialize();
		//items.push(f);
		//alert(f);
		$.ajax({
			url:"/erp/SK_update",
			data:f,
			type:"post",
			dataType:"json",
			success:function(result){
				if(result.code==200){
					alert("添加成功！");
					location.href="/erp/TransactionManagement/page_SKAdd";
				}else if(result.code==500){
					alert("添加失败!");
				}
				//alert(JSON.stringify(result));
			}
		});

	}

	//启动加载
	var custJOSN = null;//客户信息列表
	var stockJOSN = null;//仓库信息列表
	var currencyNameJOSN = null;//币别名称列表
	$(function (){
		//select name="" custId settleId depId depStaffId
		//客户
		/*$.ajax({
			url:"/erp/Customer_all",
			type:"post",
			dataType:"json",
			success:function (result) {
				//alert(JSON.stringify(result));
				var custId = [[${data.custId}]];
				for(var i=0;i<result.length;i++){
					if(custId == result[i].fid){
						$("select[name='custId']").append("<option selected value='"+result[i].fid+"'>"+result[i].name+"</option>");
					}else{
						$("select[name='custId']").append("<option value='"+result[i].fid+"'>"+result[i].name+"</option>");
					}

				}
				custJOSN = result;//预存 选择后填写地址

			}
		});*/

		//供应商
		$.ajax({
			url:"/erp/Supplier_all",
			type:"post",
			dataType:"json",
			success:function (result) {
				//alert(JSON.stringify(result));
				var custId = [[${data.custId}]];
				for(var i=0;i<result.length;i++){
					if(custId == result[i].fid){
						$("select[name='custId']").append("<option selected value='"+result[i].fid+"'>"+result[i].name+"</option>");
					}else{
						$("select[name='custId']").append("<option value='"+result[i].fid+"'>"+result[i].name+"</option>");
					}

				}
				custJOSN = result;//预存 选择后填写地址

			}
		});

		//部门
		$.ajax({
			url:"/erp/Depart_all",
			type:"post",
			dataType:"json",
			success:function (result) {
				//alert(JSON.stringify(result));
				for(var i=0;i<result.length;i++){
					$("select[name='depaId']").append("<option value='"+result[i].fid+"'>"+result[i].name+"</option>");
				}

			}
		});

		//职员
		$.ajax({
			url:"/erp/Staff_all",
			type:"post",
			dataType:"json",
			success:function (result) {
				//alert(JSON.stringify(result));
				for(var i=0;i<result.length;i++){
					$("select[name='saleStaf']").append("<option value='"+result[i].fid+"'>"+result[i].name+"</option>");
				}

			}
		});

		//结算方式
		$.ajax({
			url:"/erp/SettMethod_all",
			type:"post",
			dataType:"json",
			success:function (result) {
				//alert(JSON.stringify(result));
				var json={};
				json.settleName = [[${data.settleName}]];
				for(var i=0;i<result.length;i++){
					if(json.settleName == result[i].name){
						$("select[name='settleName']").append("<option selected value='"+result[i].name+"'>"+result[i].name+"</option>");
					}else{
						$("select[name='settleName']").append("<option value='"+result[i].name+"'>"+result[i].name+"</option>");
					}
				}

			}
		});

		//仓库
		$.ajax({
			url:"/erp/Store_all",
			type:"post",
			dataType:"json",
			success:function (result) {
				stockJOSN = result;//预存 选择item后追加item仓库
			}
		});

		//币别
		$.ajax({
			url:"/erp/CurrencyType_all",
			type:"post",
			dataType:"json",
			success:function (result) {
				//alert(JSON.stringify(result));
				var jsons={};
				jsons.currencyName = [[${data.currencyName}]];
				for(var i=0;i<result.length;i++){
					if(jsons.currencyName == result[i].name){
						$("select[name='currencyName']").append("<option selected value='"+result[i].name+"'>"+result[i].name+"</option>");
					}else{
						$("select[name='currencyName']").append("<option value='"+result[i].name+"'>"+result[i].name+"</option>");
					}
				}
				currencyNameJOSN=result;
			}
		});

		//会计科目
		$.ajax({
			url:"/erp/Account_all",
			type:"post",
			dataType:"json",
			success:function (result) {
				//alert(JSON.stringify(result));
				var skAccount = [[${data.skAccount}]];
				var zkAccount = [[${data.zkAccount}]];
				var fyAccount = [[${data.fyAccount}]];
				for(var i=0;i<result.length;i++){

					if(skAccount == result[i].fid){
						$("select[name='skAccount']").append("<option selected value='"+result[i].fid+"'>"+result[i].accountId+" "+result[i].accountName+"</option>");
					}else{
						$("select[name='skAccount']").append("<option value='"+result[i].fid+"'>"+result[i].accountId+" "+result[i].accountName+"</option>");
					}

					if(zkAccount == result[i].fid){
						$("select[name='zkAccount']").append("<option selected value='"+result[i].fid+"'>"+result[i].accountId+" "+result[i].accountName+"</option>");
					}else{
						$("select[name='zkAccount']").append("<option value='"+result[i].fid+"'>"+result[i].accountId+" "+result[i].accountName+"</option>");
					}

					if(fyAccount == result[i].fid){
						$("select[name='fyAccount']").append("<option selected value='"+result[i].fid+"'>"+result[i].accountId+" "+result[i].accountName+"</option>");
					}else{
						$("select[name='fyAccount']").append("<option value='"+result[i].fid+"'>"+result[i].accountId+" "+result[i].accountName+"</option>");
					}

				}

			}
		});
	});

	//点击来源 获取item信息
	function getitem(page){
		if(page == "切换"){//切换来源则清空全局查询
			$("input[name='cnm']").val("");
		}
		$("#items tr").empty("");//删除全部行
		showtext();//判断是否显示范围
		AppendTrHead();//添加表头
		var data = getItemByPage(page);//根据翻页按钮获取条件
		reqappend(data);//添加表体
	}

	//请求并插入items
	function reqappend(data){
		var sourcetype = $("#sourcetype").val();

		if(sourcetype == "库存产品"){
			//请求并插入
			$.ajax({
				url:"/erp/Item_queryByCNM?id="+new Date(),
				data: data,
				type:"post",
				dataType:"json",
				success:function(result){
					for(var i=0;i<result.data.length;i++){
						var fid = result.data[i].fid;
						var code = result.data[i].code;
						var name = result.data[i].name;
						var model = result.data[i].model;
						var custItemCode = result.data[i].custItemCode;
						var custItemModel = result.data[i].custItemModel;
						var saleUnitIdName = result.data[i].saleUnitIdName;
						var salePrice = result.data[i].salePrice;
						var purPrice = result.data[i].purPrice;
						var defaultCustomerIdName = result.data[i].defaultCustomerIdName;
						var defaultStorehouseIdName = result.data[i].defaultStorehouseIdName;
						var defaultStorehouseId = result.data[i].defaultStorehouseId;
						var staffIdName = result.data[i].staffIdName;
						var custOrderNum = "";
						var batchNumber = "";
						var sourFid = 0;
						var sourBillNo = '';
						var sourEntryId = 0;
						var apphtml = "<tr>" +
								"<td id='fid"+fid+"'><input type='checkbox' value='"+fid+"' ></td>" +
								"\t\t\t\t\t\t\t\t<td id='code"+fid+"'>"+code+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='name"+fid+"'>"+name+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='model"+fid+"'>"+model+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='custItemCode"+fid+"'>"+custItemCode+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='custItemModel"+fid+"'>"+custItemModel+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='saleUnitIdName"+fid+"'>"+saleUnitIdName+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='qty"+fid+"'><input type='text' onchange='checkNum(this)' style='width:60px;'></td>\n" +
								"\t\t\t\t\t\t\t\t<td id='salePrice"+fid+"'>"+salePrice+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='purPrice"+fid+"'>"+purPrice+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='defaultCustomerIdName"+fid+"'>"+defaultCustomerIdName+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='stockName"+fid+"'>"+defaultStorehouseIdName+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='staffIdName"+fid+"'>"+staffIdName+"</td>\n" +
								"<input type='hidden' id='itemId"+fid+"' value='"+sourFid+"' >"+
								"<input type='hidden' id='custOrderNum"+fid+"' value='"+sourFid+"' >"+
								"<input type='hidden' id='batchNumber"+fid+"' value='"+sourFid+"' >"+
								"<input type='hidden' id='sourFid"+fid+"' value='"+sourFid+"' >"+
								"<input type='hidden' id='sourBillNo"+fid+"' value='"+sourBillNo+"' >"+
								"<input type='hidden' id='sourEntryId"+fid+"' value='"+sourEntryId+"' >"+
								"<input type='hidden' id='stockId"+fid+"' value='"+defaultStorehouseId+"' >"+
								"\t\t\t\t\t\t\t</tr>";
						$("table[id='items']").append(apphtml);
						var startpage = result.startpage;
						var pagecount = result.pagecount;
						var countTatol = result.countTatol;
						$("#startpage").text(startpage);
						$("#pagecount").text(pagecount);
						$("#countTatol").text(countTatol);
						$("#nowpage").text(startpage);

					}

					//alert(JSON.stringify(result));
				}
			});
		}
		if(sourcetype == "采购入库"){
			//请求并插入
			$.ajax({
				url:"/erp/FK_sour?id="+new Date(),
				data: data,
				type:"post",
				dataType:"json",
				success:function(result){
					/*alert(JSON.stringify(result));*/
					for(var i=0;i<result.data.length;i++){
						var fid = result.data[i].fid;//唯一id
						var itemId = result.data[i].mid.itemId;//itemid
						var billNo = result.data[i].billNo;
						var billDate = result.data[i].billDate;
						var suppIdFidName = result.data[i].suppIdFid.name;
						/*var settIdFidName = result.data[i].settleIdFid.name;*/
						var rate = result.data[i].rate;
						var entryId = result.data[i].mid.entryId;//分录号
						var itemCode = result.data[i].mid.itemCode;
						var itemName = result.data[i].mid.itemName;
						var itemModel = result.data[i].mid.itemModel;
						var custItemCode = result.data[i].mid.custItemCode;
						var custItemModel = result.data[i].mid.custItemModel;
						var unitName = result.data[i].mid.unitName;
						var qty = result.data[i].mid.qty;//送货数量
						var saleOrderBillNo = result.data[i].suppIdFid.address;
						var stockId = result.data[i].mid.stockId;
						var stockName = result.data[i].suppIdFid.abb;
						var custOrderNum = result.data[i].mid.custOrderNum;
						var batchNumber = result.data[i].mid.batchNumber;
						var taxPrice = result.data[i].mid.taxPrice;
						var taxPriceNo = result.data[i].mid.taxPriceNo;
						var taxAmt = result.data[i].mid.taxAmt;
						var sourFid = result.data[i].mid.fid;
						var sourEntryId = result.data[i].mid.entryId;
						var soQty = result.data[i].suppIdFid.cust_type_id;//订单数量
						var hxAmt = result.data[i].mid.hxAmt;//已核销金额
						var apphtml = "<tr>" +
								"<td id='fid"+fid+"'><input type='checkbox' value='"+fid+"' ></td>" +
								"\t\t\t\t\t\t\t\t<td id='billNo"+fid+"'>"+billNo+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='billDate"+fid+"'>"+billDate+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td>"+suppIdFidName+"</td>\n" +
								/*"\t\t\t\t\t\t\t\t<td>"+settIdFidName+"</td>\n" +*/
								"\t\t\t\t\t\t\t\t<td id='rate"+fid+"'>"+rate+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td>"+entryId+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='code"+fid+"'>"+itemCode+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='name"+fid+"'>"+itemName+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='model"+fid+"'>"+itemModel+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='custItemCode"+fid+"'>"+custItemCode+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='custItemModel"+fid+"'>"+custItemModel+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='saleUnitIdName"+fid+"'>"+unitName+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='saleOrderBillNo"+fid+"'>"+saleOrderBillNo+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='saleOrderQty"+fid+"'>"+soQty+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='qty"+fid+"'>"+qty+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='stockName"+fid+"'>"+stockName+"</td>\n" +
								/*"\t\t\t\t\t\t\t\t<td id='qty"+fid+"'>"+(qty-ydzQty)+"</td>\n" +*/
								"\t\t\t\t\t\t\t\t<td id='custOrderNum"+fid+"'>"+custOrderNum+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='batchNumber"+fid+"'>"+batchNumber+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='salePrice"+fid+"'>"+taxPrice+"</td>\n" +
								"\t\t\t\t\t\t\t\t<td id='taxAmt"+fid+"'>"+taxAmt+"</td>\n" +
								/*"\t\t\t\t\t\t\t\t<td id='salePriceNo"+fid+"'>"+taxPriceNo+"</td>\n" +*/
								"\t\t\t\t\t\t\t\t<td id='hxAmt"+fid+"'>"+(taxAmt-hxAmt)+"</td>\n" +
								"<input type='hidden' id='itemId"+fid+"' value='"+itemId+"' >"+
								"<input type='hidden' id='sourFid"+fid+"' value='"+sourFid+"' >"+
								"<input type='hidden' id='sourBillNo"+fid+"' value='"+billNo+"' >"+
								"<input type='hidden' id='sourEntryId"+fid+"' value='"+sourEntryId+"' >"+
								"<input type='hidden' id='stockId"+fid+"' value='"+stockId+"' >"+
								"\t\t\t\t\t\t\t</tr>";
						$("table[id='items']").append(apphtml);
						var startpage = result.startpage;
						var pagecount = result.pagecount;
						var countTatol = result.countTatol;
						$("#startpage").text(startpage);
						$("#pagecount").text(pagecount);
						$("#countTatol").text(countTatol);
						$("#nowpage").text(startpage);

					}

					//alert(JSON.stringify(result));
				}
			});
		}

	}

	//添加表头
	function AppendTrHead(){
		//库存产品
		var kccp = "<tr>"+
				"<th style='width:60px'>选中</th>"+
				"<th>编码</th>"+
				"<th>名称</th>"+
				"<th>型号</th>"+
				"<th>客户编码</th>"+
				"<th>客户型号</th>"+
				"<th>销售单位</th>"+
				"<th>数量</th>"+
				"<th>销售价格</th>"+
				"<th>采购价格</th>"+
				"<th>默认客户</th>"+
				"<th>默认仓库</th>"+
				"<th>负责人</th>"+
				"</tr>";
		//采购入库
		var cgdd = "<tr>"+
				"<th style='width:60px'>选中</th>"+
				"<th>单号</th>"+
				"<th>日期</th>"+
				"<th>客户</th>"+
				/*"<th>结算方式</th>"+*/
				"<th>税率</th>"+
				"<th>分录号</th>"+
				"<th>编码</th>"+
				"<th>名称</th>"+
				"<th>型号</th>"+
				"<th>客户编码</th>"+
				"<th>客户型号</th>"+
				"<th>单位</th>"+
				"<th>订单单号</th>"+
				"<th>订单数量</th>"+
				"<th>送货数量</th>"+
				"<th>出货仓库</th>"+
				/*"<th>未对账数量</th>"+*/
				"<th>客户订单号</th>"+
				"<th>批号</th>"+
				"<th>含税单价</th>"+
				"<th>含税金额</th>"+
				"<th>未核销金额</th>"+
				"</tr>";
		var sourcetype = $("#sourcetype").val();//选择的来源
		if(sourcetype == "库存产品"){
			$("table[id='items']").append(kccp);
		}
		if(sourcetype == "采购入库"){
			$("table[id='items']").append(cgdd);
		}


	}

	//获取翻页查询条件
	function getItemByPage(page){
		var startpage = parseFloat($("#nowpage").text());//当前页数
		var pagesize = parseFloat($("#pagesize").val());//每页条数
		var pagecount = parseFloat($("#pagecount").text());//总页数
		var range = $("#range").val();//选择的范围
		var cnm = $("input[name='cnm']").val();
		var custId = $("select[name='custId']").val();//单据组织
		cnm = cnm == null || cnm == ""?"":cnm;

		var data = {range:range,suppId:custId};
		//alert(range);
		if(page == 'first'){
			data.startpage = 1;
			data.pagesize = pagesize;
			data.cnm = cnm;
		}else if(page == 'previous'){
			data.startpage = (startpage-1)>0?(startpage-1):1;
			data.pagesize = pagesize;
			data.cnm = cnm;
		}else if(page == 'next'){
			data.startpage = (startpage+1)>pagecount?pagecount:(startpage+1);
			data.pagesize = pagesize;
			data.cnm = cnm;
		}else if(page == 'last'){
			data.startpage = pagecount;
			data.pagesize = pagesize;
			data.cnm = cnm;
		}else{//默认没有
			data.startpage = startpage;
			data.pagesize = pagesize;
			data.cnm = cnm;
		}
		//alert(data);
		return data;
	}

	//判断是否显示范围 未入库 已入库
	function showtext(){
		var sourcetype = $("#sourcetype").val();
		if(sourcetype == "采购入库"){
			$("#range").show();
		}else{
			$("#range").hide();
		}
	}

	//获取已存在行的fid
	function gettrfid(){
		var arr = new Array();
		var i = 0;
		$.each($(".num"), function() {
			arr[i] = $(this).text();
			i++;
		});
		return arr;
	}

	//获取已存在行的fid  itemId
	function getClassTr(classstr){
		var arr = new Array();
		var i = 0;
		$.each($("."+classstr), function() {
			arr[i] = $(this).val();
			i++;
		});
		return arr;
	}

	//获取checkbox选中的value数据
	var trlen = [[${datas.size()}]];//行号累计 已存在的行
	var arr = new Array();
	function getHabit() {
		//$('input:checkbox:checked') 等同于 $('input[type=checkbox]:checked')
		var ids  = new Array();
		var i = 0;
		//获取选中的id
		$.each($('input:checkbox:checked'), function() {
			ids[i] = $(this).val();
			i++;
		});

		//添加到行
		for(j = 0,len=ids.length; j < len; j++) {

			//行号
			trlen = trlen+1;
			var fid = $("#fid"+ids[j]+" input").val();
			var itemId = $("#itemId"+ids[j]).val();
			var code = $("#code"+ids[j]).text();
			var name = $("#name"+ids[j]).text();
			var model = $("#model"+ids[j]).text();
			var custItemCode = $("#custItemCode"+ids[j]).text();
			var custItemModel = $("#custItemModel"+ids[j]).text();
			var saleUnitIdName = $("#saleUnitIdName"+ids[j]).text();
			var saleOrderBillNo = $("#saleOrderBillNo"+ids[j]).text();
			var saleOrderQty = $("#saleOrderQty"+ids[j]).text();
			var qty = $("#qty"+ids[j]).text();
			if(qty <= 0){
				qty = 1;
			}
			var stockId = $("#stockId"+ids[j]).val();
			var stockName = $("#stockName"+ids[j]).text();
			var custOrderNum = $("#custOrderNum"+ids[j]).text();
			var salePrice = $("#salePrice"+ids[j]).text();
			var taxAmt = $("#taxAmt"+ids[j]).text();
			var hxAmt = $("#hxAmt"+ids[j]).text();
			/*var salePriceNo = $("#salePriceNo"+ids[j]).text();*/
			/*var amt = qty*salePrice;*/
			var batchNumber = $("#batchNumber"+ids[j]).text();
			var sourFid = $("#sourFid"+ids[j]).val();
			var sourBillNo = $("#sourBillNo"+ids[j]).val();
			var billDate = $("#billDate"+ids[j]).text();
			var sourEntryId = $("#sourEntryId"+ids[j]).val();
			var sourcetype = $("#sourcetype").val();
			//alert(qty);

			var insertrow = "<tr>"+
					"<input type='hidden' class='itemIdNum' value='"+fid+trlen+"'>"+
					"<input type='hidden' class='itemId' name='itemId0"+fid+trlen+"' value='"+itemId+"' style='width:20px;'>"+
					"<td>"+
					"<span class='num'>"+trlen+"</span>"+
					"<span class='glyphicon glyphicon-minus' onclick='del_row(this)'></span>"+
					"</td>"+
					"<td>"+sourcetype+"</td>"+
					"<td>"+sourBillNo+"</td>"+
					"<td>"+billDate+"</td>"+
					"<td>"+sourEntryId+"</td>"+
					"<td>"+custOrderNum+"<input type='hidden' name='custOrderNum0"+fid+trlen+"' value='"+custOrderNum+"' style='width:100px;'></td>"+
					"<td>"+code+"<input type='hidden' name='itemCode0"+fid+trlen+"' value='"+code+"' style='width:20px;'></td>"+
					"<td>"+name+"<input type='hidden' name='itemName0"+fid+trlen+"' value='"+name+"' style='width:20px;'></td>"+
					"<td>"+model+"<input type='hidden' name='itemModel0"+fid+trlen+"' value='"+model+"' style='width:20px;'></td>"+
					"<td>"+custItemCode+"<input type='hidden' name='custItemCode0"+fid+trlen+"' value='"+custItemCode+"' style='width:20px;'></td>"+
					"<td>"+custItemModel+"<input type='hidden' name='custItemModel0"+fid+trlen+"' value='"+custItemModel+"' style='width:20px;'></td>"+
					"<td>"+saleUnitIdName+"<input type='hidden' name='unitName0"+fid+trlen+"' value='"+saleUnitIdName+"' style='width:20px;'></td>"+
					/*"<td>"+saleOrderBillNo+"<input type='hidden' name='saleOrderBillNo0"+fid+trlen+"' value='"+saleOrderBillNo+"' style='width:100px;'></td>"+
					"<td>"+saleOrderQty+"<input type='hidden' name='saleOrderQty0"+fid+trlen+"' value='"+saleOrderQty+"' class='checkNum4' readonly style='width:60px;'></td>"+*/
					"<td id='qty_"+trlen+"'>"+qty+"<input type='hidden' id='qty_"+trlen+"' name='qty0"+fid+trlen+"' value='"+qty+"' class='checkNum4' onchange='checkNum(this,'qty',"+trlen+")' style='width:60px;'></td>"+
					/*"<td>"+stockName+"<input type='hidden' name='stockId0"+fid+trlen+"' value='"+stockId+"'></td>"+
					"<td><select id='stockId_"+trlen+"' name='stockId0"+fid+trlen+"' class='selectpicker show-tick form-control' data-live-search='true' data-actions-box='true'> style='width:100px;'" +
					"	<option value='-1'></option>" +
					"</select></td>"+
					"<td>"+batchNumber+"<input type='hidden' name='batchNumber0"+fid+trlen+"' value='"+batchNumber+"' style='width:100px;'></td>"+*/
					"<td>"+salePrice+"<input type='hidden' id='taxPrice_"+trlen+"' name='taxPrice0"+fid+trlen+"' value='"+salePrice+"' class='checkNum4' onchange='checkNum4(this,'tax',"+trlen+")' style='width:50px;'></td>"+
					/*"<td>"+salePriceNo+"<input type='hidden' id='taxPriceNo_"+trlen+"' name='taxPriceNo0"+fid+trlen+"' value='"+salePriceNo+"' class='checkNum4' onchange='checkNum4(this,'taxno',"+trlen+")' style='width:50px;'></td>"+*/
					"<td id='taxamt"+trlen+"'>"+taxAmt+"<input type='hidden' name='taxAmt0"+fid+trlen+"' value='"+taxAmt+"' readonly></td>"+
					"<td><input type='text' id='hxAmt"+trlen+"' name='hxAmt0"+fid+trlen+"' value='"+hxAmt+"' onchange='total()' style='width:100px;'></td>"+
					"<td><input type='text' name='rowRemark0"+fid+trlen+"' style='width:100px;'></td>"+

					"<input type='hidden' name='sourFid0"+fid+trlen+"' value='"+sourFid+"' >"+
					"<input type='hidden' name='sourType0"+fid+trlen+"' value='"+sourcetype+"' >"+
					"<input type='hidden' name='sourBillNo0"+fid+trlen+"' value='"+sourBillNo+"' >"+
					"<input type='hidden' name='sourEntryId0"+fid+trlen+"' value='"+sourEntryId+"' >"+
					"<input type='hidden' name='sourBillDate0"+fid+trlen+"' value='"+billDate+"' >"+
					"</tr>";
			$(".panel-infos table").append(insertrow);
			arr.push(trlen);

			//重新加载时间控件
			$('.form_date').datetimepicker({
				language : 'zh-CN',
				format : 'yyyy-mm-dd',//日期格式
				weekStart: 1,
				todayBtn:  1,
				autoclose: 1,
				todayHighlight: 1,
				startView: 2,
				minView: 2,
				forceParse: 0
			});
			$("input[name='finishDate0"+fid+trlen+"']").val(end);//时间赋予
			//仓库赋予
			/*for(var i=0;i<stockJOSN.length;i++){
				if(stockId == stockJOSN[i].fid){
					$("select[name='stockId0"+fid+trlen+"']").append("<option selected value='"+stockJOSN[i].fid+"'>"+stockJOSN[i].name+"</option>");
				}else{
					$("select[name='stockId0"+fid+trlen+"']").append("<option value='"+stockJOSN[i].fid+"'>"+stockJOSN[i].name+"</option>");
				}
			}*/

		}
		//window.alert("你选了" + $('input[type=checkbox]:checked').length + "个,其中有" + ids);
		closemodal("myModal","hide");//关闭拟态框
		ratejs('rate',-1);//重新根据汇率计算不含税价
		//重新加载时间控件
		$('.form_date').datetimepicker({
			language : 'zh-CN',
			format : 'yyyy-mm-dd',//日期格式
			weekStart: 1,
			todayBtn:  1,
			autoclose: 1,
			todayHighlight: 1,
			startView: 2,
			minView: 2,
			forceParse: 0
		});
		$(".form_date").val(end);//时间赋予

	}

	//正整数判断 var regex = /^([1-9]\d{0,15}|0)(\.\d{1,4})?$/;
	function checkNum(obj,type,fid){
		var value = obj.value;
		var re = /^[1-9]{1}[0-9]*$/;//正整数
		if(!re.test(value)){
			obj.value=0;
			alert("请输入正整数！");
		}

		//2、计算
		ratejs(type,fid);
	}

	//正数小数点4位判断 var regex = /^([1-9]\d{0,15}|0)(\.\d{1,4})?$/;
	function checkNum4(obj,type,fid){
		var value = obj.value;
		var re = /^([1-9]\d{0,15}|0)(\.\d{1,4})?$/;//正数4位小数点
		if(!re.test(value)){
			obj.value=0;
			alert("请输入正确数值！(4位小数点)");
		}

		//2、计算
		ratejs(type,fid);
	}

	//正数小数点4位判断 全局试用
	$(document).on("change",".checkNum4",function (e){
		var target=e.target||e.srcElement;//获取当前点击的对象
		var e_id = target.id;
		var str = e_id.split('_');//id+序号
		var type = str[0];
		var fid = str[1];

		var value = $("#"+e_id+"").val();
		var re = /^([1-9]\d{0,15}|0)(\.\d{1,4})?$/;//正数4位小数点
		if(!re.test(value)){
			$("#"+e_id+"").val(0);
			alert("请输入正确数值！(4位小数点)");
		}


		//2、计算
		ratejs(type,fid);

	});

	//小数点四舍五入 数值 位数
	function decimal(num,v){
		var vv = Math.pow(10,v);
		return Math.round(num*vv)/vv;
	}

	//合计
	function total(){
		var rate = $("input[name='rate']").val();
		var hxAmtTotal = 0;
		var taxAmtTotal = 0;
		var taxAmtnoTotal = 0;

		var trlens = gettrfid();
		for (id in trlens){
			taxAmtTotal += parseFloat($("#taxamt"+trlens[id]).text());
			hxAmtTotal += parseFloat($("#hxAmt"+trlens[id]).val());
		}
		taxAmtnoTotal = taxAmtTotal/(1+(rate/100));

		/*$('.panel-infos tr').each(function() {
			$(this).find('td:eq(11)').each(function(){
				taxAmtTotal += parseFloat($(this).text());
			});
		});*/
		$("#hxAmtTotal").text(decimal(hxAmtTotal,4));//核销金额合计
		$("#skAmt").val(decimal(hxAmtTotal,4));//核销金额合计
		$("#taxAmtTotal").text(decimal(taxAmtTotal,4));//含税金额合计
		$("#taxAmtnoTotal").text(decimal(taxAmtnoTotal,4));//b不含税金额合计

		sumhxAmt();//合计核销金额
	}

	//计算
	function ratejs(type,fid){
		var taxPrice=$("#taxPrice_"+fid+"").val();//当前含税单价
		var taxPriceNo = $("#taxPriceNo_"+fid+"").val();//当前不含税单价
		var qty = $("#qty_"+fid+"").val();//当前数量
		var rate = $("input[name='rate']").val();//当前税率
		var amt = $("#taxamt"+fid+"").text();//当前含税金额
		//alert(taxPrice+"=="+qty);

		var taxPriceNoup = taxPrice/(1+(rate/100));
		var taxPriceup = taxPriceNo*(1+(rate/100));

		if(type=="qty"){//数量改变
			/*$("#taxamt"+fid+"").text( decimal(qty*taxPrice,4) );//1、含税金额更新*/
		}else if(type=="taxPrice"){//含税单价改变
			$("#taxPriceNo_"+fid+"").val( decimal(taxPriceNoup,4) );//1、不含税单价更新
			/*$("#taxamt"+fid+"").text( decimal(qty*taxPrice,4) );//2、含税金额更新*/
		}else if(type=="taxPriceNo"){//不含税单价改变
			$("#taxPrice_"+fid+"").val( decimal(taxPriceup,4) );//1、含税单价跟新
			/*$("#taxamt"+fid+"").text( decimal(qty*taxPriceup,4) );//2、含税金额更新*/
		}else if(type=="rate"){//税率改变
			for (id in arr){
				ratejs('taxPrice',arr[id]);
			}
		}
		total();//合计
	}

	//获取联系方式 根据客户id
	function getcontact(){
		var trlens = gettrfid();
		for (id in trlens){
			var sourType = $("#sourType"+trlens[id]).val();
			if(sourType != "库存产品"){
				alert("已选择其他客户的订单！");
				break;
			}
		}

		var custId = $("select[name='custId']").val();
		/*alert(custId);
		alert(custJOSN.length);*/
		for(var i=0;i<custJOSN.length;i++){
			if(custJOSN[i].fid == custId){
				var rate = custJOSN[i].vat_rate;
				if(rate!=null){
					$("#rate").val(rate);
				}else{
					$("#rate").val(0);
				}
				$("#contact_bill").val(custJOSN[i].contact);
				$("#phone_bill").val(custJOSN[i].phone);
				$("#address_bill").val(custJOSN[i].address);
				$("#selected_cust").val(custJOSN[i].name);
			}
		}
	}

	//更新当前仓库情况
    function getstocks(){
		//每次选择清空选项
		$("#nowstock").empty();
		$("#startstock").empty();
		$("#endstock").empty();

		var trs = $("#mainTable").find("tr").length-1;//总共行数
		if(trs>1){
			var nowtr = 1;
			var strat = 2;
			var end = trs;

			for(var i=1;i<=trs;i++){
				if(nowtr == i){//被复制仓库的行
					$("#nowstock").append("<option selected value='"+i+"''>"+i+"</option>");
				}else{
					$("#nowstock").append("<option value='"+i+"''>"+i+"</option>");
				}
				if(strat == i){//开始粘贴仓库的行
					$("#startstock").append("<option selected value='"+i+"''>"+i+"</option>");
				}else{
					$("#startstock").append("<option value='"+i+"''>"+i+"</option>");
				}
				if(end == i){//结束粘贴的行
					$("#endstock").append("<option selected value='"+i+"''>"+i+"</option>");
				}else{
					$("#endstock").append("<option value='"+i+"''>"+i+"</option>");
				}
			}
			closemodal("ModalBatchStock","show");//打开拟态框
		}else{
			alert("行数不足，请先增加行数再批量复制！");
		}

    }

	//批量更新仓库
	function batchStock(){
        var nowstock = $("#nowstock").val();
        var startstock = $("#startstock").val();
        var endstock = $("#endstock").val();
        //获取到当前行的仓库id
		var itemIdNums = getClassTr("itemIdNum");//itemid+序号
		var nowstockid = null;//当前仓库id
		for(itemIdNum in itemIdNums){
			if(nowstock-1 == itemIdNum){//序号一致
				nowstockid = itemIdNums[itemIdNum];
				break;
			}
		}
		var nowstockval = $("select[name='stockId0"+nowstockid+"']").val();//当前仓库id值
		//批量赋予仓库id stockId01232
        if(startstock>endstock){
        	var temp = endstock;
        	endstock = startstock;
        	startstock = temp;
		}

		for(var i=startstock;i<=endstock;i++){
			for(itemIdNum in itemIdNums){
				if(i-1 == itemIdNum){//序号一致
					$("select[name='stockId0"+itemIdNums[itemIdNum]+"'] option[value='"+nowstockval+"']").attr("selected","selected");
					break;
				}
			}
		}
		closemodal("ModalBatchStock","hide");//关闭拟态框
    }

	//更新table高度
	function upd_clientheight(type){
		if(type == 'show'){
			var clientHeight = document.body.clientHeight-290;//可用页面高度-90(top84-底部预留6)
		}else if(type == 'close'){
			var clientHeight = document.body.clientHeight-170;//可用页面高度-90(top84-底部预留6)
		}

		document.getElementById("table_main").style.maxHeight = clientHeight+"px";
	}

	//页面头缩小
	function page_close(){
		$("#open").show();
		$("#close").hide();
		$("#panel-body-header").hide();
		upd_clientheight('close');
	}

	//页面头扩大
	function page_show(){
		$("#close").show();
		$("#open").hide();
		$("#panel-body-header").show();
		upd_clientheight('show');
	}

	function upd_exchangeRate(){
		var currencyName = $("select[name='currencyName']").val();
		/*alert(custId);currencyNameJOSN
		alert(custJOSN.length);*/
		for(var i=0;i<currencyNameJOSN.length;i++){
			if(currencyNameJOSN[i].name == currencyName){
				var exchangeRate = currencyNameJOSN[i].exchangeRate;
				$("#exchangeRate").val(exchangeRate);
			}
		}
	}

	function sumhxAmt(){
		var skAmt = parseFloat($("#skAmt").val());//核销金额
		var zkAmt = parseFloat($("#zkAmt").val());//折扣金额
		var fyAmt = parseFloat($("#fyAmt").val());//费用金额

		var sumhxAmtTotal = skAmt + zkAmt + fyAmt;
		$("#sumhxAmtTotal").val(decimal(sumhxAmtTotal,4));//核销金额合计
	}
	
</script>

<style type="text/css">

	body{
		background-color:#FCFCFC;
	}
	
	.panel-body{
		padding-top:0px;
	}
	
	.panel-body .input-group{
		margin-right:20px;
		margin-top:5px;
		width:200px;
		float:left;
	}
	
	.list-group-item{
		padding:5px 10px;
	}
	
	.list-group{
		float:left;
		margin-right:100px;
	}
	
	.table{
		float:left;
		margin-top:1px;
	}
	
	tr td,th{
		text-align:center;
		font-size:12px;
		overflow: hidden; /*超过区域就隐藏*/
		white-space: nowrap; /*规定段落中的文本不进行换行*/
		text-overflow: ellipsis; /*显示省略符号来代表被修剪的文本。*/
	}
	
	.glyphicon-minus{
		display:none;
	}
	
	tr td:hover .glyphicon-minus{
		display:block;
	}
	
	tr td:hover .num{
		display:none;
	}

	.diylabel{
		margin-top:10px;
		margin-left:20px;
		float:left;
	}
	
	
</style>

<title>付款单</title>
</head>
<body>


<div class="panel panel-info">
	<div class="panel-heading">
		<b>付款单-编辑</b>
		<b style="margin-left:30px;" th:text="${data.billNo}">SO-201025001</b>
		<div class="btn-group btn-group-sm p" role="group" aria-label="..." style="float:right;margin-top: -7px;">
			<button type="button" onclick="fromcheck()" class="btn btn-default">提交</button>
			<div class="btn-group btn-group-sm" role="group">
				<button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
					Other
					<span class="caret"></span>
				</button>
				<ul class="dropdown-menu">
					<li><a href="#">提交并审核</a></li>
					<li><a href="#">提交并新建</a></li>
				</ul>
			</div>
			<div style="float:right;margin-top: 7px;margin-left: 15px;">
				<button class="btn btn-info btn-xs">
					<span class="glyphicon glyphicon-resize-small" id="close" onclick="page_close()"></span>
					<span class="glyphicon glyphicon-resize-full" id="open" onclick="page_show()"></span>
				</button>
			</div>
		</div>
		
	</div>

	<form method="post" action="#" id="f1">
		<input type="hidden" name="billType" value="付款单">
		<input type="hidden" name="billNo" th:value="${data.billNo}">
		<div class="panel-body" id="panel-body-header">

			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button"><span class="glyphicon glyphicon-star" style="color:#ff0000;"></span>供应商</button>
				 </span>
				<select name="custId" onchange="getcontact()" class="selectpicker show-tick form-control form-control-lg" data-live-search="true" data-actions-box="true">
				　　<option value="-1">-- --</option>
				</select>
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">单据日期</button>
				 </span>
				 <input name="billDate" th:value="${data.billDate}" class="form-control form_date" readonly style="background-color: #FFFFFF;"/><!--form-control  onFocus="WdatePicker({readOnly:true,dateFmt:'yyyy-MM-dd'})" />-->
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">结算方式</button>
				 </span>
				 <select name="settleName" class="selectpicker show-tick form-control" data-live-search="true" data-actions-box="true">
					<option value="-1">-- --</option>
				</select>
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">税率</button>
				 </span>
				 <input type="text" th:value="${data.rate}" id="rate" name="rate" value="0" onchange="checkNum(this,'rate',-1)" class="form-control" placeholder="DATE" aria-describedby="basic-addon1">
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">币别</button>
				 </span>
				<select name="currencyName" onchange="upd_exchangeRate()" class="selectpicker show-tick form-control" data-live-search="true" data-actions-box="true">
					<option value="-1">-- --</option>
				</select>
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">汇率</button>
				 </span>
				<input type="text" th:value="${data.exchangeRate}" id="exchangeRate" name="exchangeRate" value="0" class="form-control" readonly aria-describedby="basic-addon1">
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">收款账号</button>
				 </span>
				<select name="skAccount" class="selectpicker show-tick form-control" data-live-search="true" data-actions-box="true">
					<option value="-1">-- --</option>
				</select>
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">收款金额</button>
				 </span>
				<input type="text" id="skAmt" th:value="${data.skAmt}" name="skAmt" value="0" onchange="sumhxAmt()" class="form-control" aria-describedby="basic-addon1">
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">折扣账号</button>
				 </span>
				<select name="zkAccount" class="selectpicker show-tick form-control" data-live-search="true" data-actions-box="true">
					<option value="-1">-- --</option>
				</select>
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">折扣金额</button>
				 </span>
				<input type="text" id="zkAmt" th:value="${data.zkAmt}" name="zkAmt" value="0" onchange="sumhxAmt()" class="form-control" aria-describedby="basic-addon1">
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">费用账号</button>
				 </span>
				<select name="fyAccount" class="selectpicker show-tick form-control" data-live-search="true" data-actions-box="true">
					<option value="-1">-- --</option>
				</select>
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">费用金额</button>
				 </span>
				<input type="text" id="fyAmt" th:value="${data.fyAmt}" name="fyAmt" onchange="sumhxAmt()" class="form-control" aria-describedby="basic-addon1">
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">核销金额合计</button>
				 </span>
				<input type="text" th:value="${data.hxAmtTotal}" id="sumhxAmtTotal" name="hxAmtTotal" readonly class="form-control" aria-describedby="basic-addon1">
			</div>
			<!--<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">收货地址</button>
				 </span>
				<input type="text" name="address" id="address_bill" class="form-control" aria-describedby="basic-addon1" readonly>
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">联系人</button>
				 </span>
				 <input type="text" name="contact" id="contact_bill" class="form-control" aria-describedby="basic-addon1" readonly>
			</div>
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">电话</button>
				 </span>
				 <input type="text" name="phone" id="phone_bill" class="form-control" aria-describedby="basic-addon1" readonly>
			</div>-->
			<div class="input-group input-group-sm">
				<span class="input-group-btn">
					<button class="btn btn-info" type="button">摘要</button>
				 </span>
				 <input type="text" th:value="${data.remark}" name="remark" class="form-control" placeholder="PHONE" aria-describedby="basic-addon1">
			</div>

		</div>
		
		
		<div class="panel panel-default">
			<div class="panel-heading">单据信息</div>
			<div class="panel-body" style="padding-left: 0;">
				<ul class="nav nav-tabs">
					<li role="presentation" onclick="navcut(this,'contact')" class="active"><a href="#">产品</a></li>
					<!-- <li role="presentation" onclick="navcut(this,'currency')"><a href="#">货币信息</a></li> -->
					<li role="presentation" onclick="navcut(this,'otherinfo')"><a href="#">其他</a></li>
					
					<li style="float:right;" id="btn-row">
						<a href="#">
							<button class="btn btn-info btn-xs" onclick="getitem(0)" type="button" data-toggle="modal" data-target="#myModal">来源</button>
							<!--<button class="btn btn-info btn-xs" onclick="testinsert()" type="button">test插入</button>-->
							<!--<button class="btn btn-info btn-xs" type="button" onclick="del_row()">删行</button>-->
						</a>
					</li>
				</ul>
				
				<div class="panel-infos" id="contact">
					<div id="table_main" style="overflow-x:auto;overflow-y:auto;">
						<table id="mainTable" class="table table-striped table-bordered table-condensed table-hover" style="max-width:2000px;min-width: 1200px;">
							<tr>
								<th width="10px">行号</th>
								<th>源单类型</th>
								<th>源单单号</th>
								<th>源单日期</th>
								<th>源单序号</th>
								<th>客户订单号</th>
								<th>产品编码</th>
								<th>名称</th>
								<th>型号</th>
								<th>客户产品编码</th>
								<th>客户产品型号</th>
								<th>单位</th>
								<th>实发数量</th>
								<th>单价(含税)</th>
								<th>金额(含税)</th>
								<th>核销金额</th>
								<th>备注</th>
							</tr>
							<tr th:each="d,state:${datas}">
								<input type='hidden' class='itemIdNum' th:value="|${d.itemId}${state.index+1}|">
								<input type='hidden' class='itemId' th:name="|itemId0${d.itemId}${state.index+1}|" th:value="${d.itemId}">
								<td>
									<span class='num' th:text="${state.index+1}"></span>
									<span class='glyphicon glyphicon-minus' onclick='del_row(this)'></span>
									</td>
								<td th:text="${d.sourType}"></td>
								<td th:text="${d.sourBillNo}"></td>
								<td th:text="${d.sourBillDate}">"</td>
								<td th:text="${d.sourEntryId}"></td>
								<td th:text="${d.custOrderNum}"></td>
								<td th:text="${d.itemIds.code}"></td>
								<td th:text="${d.itemIds.name}"></td>
								<td th:text="${d.itemIds.model}"></td>
								<td th:text="${d.itemIds.custItemCode}"></td>
								<td th:text="${d.itemIds.custItemModel}"></td>
								<td th:text="${d.itemIds.saleUnitIdName}"></td>
								<td th:id="|qty_${state.index+1}|" th:text="${d.qty}"></td>
								<td th:text="${d.taxPrice}"></td>
								<td th:text="${d.taxAmt}" th:id="|taxamt${state.index+1}|"></td>
								<td><input type='text' th:id="|hxAmt${state.index+1}|" th:name="|hxAmt0${d.itemId}${state.index+1}|" th:value="${d.hxAmt}" onchange='total()' style='width:100px;'></td>
								<td><input type='text' th:name="|rowRemark0${d.itemId}${state.index+1}|" th:value="${d.rowRemark}" style='width:100px;'></td>
								<input type='hidden' th:name="|sourFid0${d.itemId}${state.index+1}|" th:value="${d.sourFid}">
								<input type='hidden' th:name="|sourType0${d.itemId}${state.index+1}|" th:value="${d.sourType}">
								<input type='hidden' th:name="|sourBillNo0${d.itemId}${state.index+1}|" th:value="${d.sourBillNo}">
								<input type='hidden' th:name="|sourEntryId0${d.itemId}${state.index+1}|" th:value="${d.sourEntryId}">
								<input type='hidden' th:name="|sourBillDate0${d.itemId}${state.index+1}|" th:value="${d.sourBillDate}">
								<input type='hidden' th:name="|custOrderNum0${d.itemId}${state.index+1}|" th:value="${d.custOrderNum}">
								<input type='hidden' th:name="|qty0${d.itemId}${state.index+1}|" th:value="${d.qty}" th:id="|qty_${state.index+1}|">
								<input type='hidden' th:name="|taxPrice0${d.itemId}${state.index+1}|" th:value="${d.taxPrice}" th:id="|taxPrice_${state.index+1}|">
								<input type='hidden' th:name="|taxAmt0${d.itemId}${state.index+1}|" th:value="${d.taxAmt}">
							</tr>
						</table>
					</div>
					<div class="panel-body" style="padding:0;height:40px;">
						<div class="diylabel">
							<label>核销金额(合计):</label>
							<label id="hxAmtTotal">0.00</label>
						</div>
						<!--<div class="diylabel">
							<label>不含税金额:</label>
							<label id="taxAmtnoTotal">0.00</label>
						</div>-->
					</div>
				</div>
				
				<!-- <div class="panel-infos" id="currency" hidden>
					
					<div class="input-group">
					  <span class="input-group-btn">
							<button class="btn btn-default" type="button">结算方式</button>
					  </span>
					  <select name="select" class="selectpicker show-tick form-control form-control-lg" data-live-search="true" data-actions-box="true">
							<option value="">-- --</option>　　
							<option value="等于">管理员</option>
						　　<option value="大于">张三</option>
						　　<option value="小于">李四</option>
						</select>
					</div>
					
				</div> -->
				
				<div class="panel-infos" id="otherinfo" hidden>
					<div class="panel-body"><!--style="padding:0;margin-top:-20px;"-->
						<div class="input-group input-group-sm">
						<span class="input-group-btn">
							<button class="btn btn-info" type="button">制单</button>
						 </span>
							<input type="text" class="form-control" value="admin" disabled aria-describedby="basic-addon1">
						</div>
						<div class="input-group input-group-sm">
						<span class="input-group-btn">
							<button class="btn btn-info" type="button">审核</button>
						 </span>
							<input type="text" class="form-control" value="" disabled aria-describedby="basic-addon1">
						</div>
					</div>
				</div>
				
			</div>
			
		</div>
	</form>
</div>


<!-- 模态框声明 -->
	<div class="modal fade" id="myModal" style="height:600px;">
		<!-- 窗口声明 -->
		<div class="modal-dialog" style="width:95%;">
			<!-- 内容声明 -->
			<div class="modal-content">
			
				<div class="modal-header" style="height:50px;">
					<button class="close" data-dismiss="modal"><span>&times;</span></button>
					<h6 class="modal-title">
						<select id="sourcetype" onchange="getitem('切换')" style="height:30px;width:200px;float:left;" class="selectpicker show-tick form-control" data-live-search="true" data-actions-box="true">
							<option value="采购入库">采购入库</option>
							<!--<option value="库存产品">库存产品</option>-->
						</select>
					</h6>
					<input type="text" id="selected_cust" readonly class="form-control" style="width:200px;height: 30px;">
				</div>
				<div class="modal-body">
					<div class="container-fluid">
						<form class="form-inline">
							<div class="form-group">
								<input type="text" name="cnm" class="form-control" placeholder="请输入物料编码、名称或型号" style="width:300px;">
							</div>
							<button type="button" onclick="getitem(0)" class="btn btn-info">查询</button>
							<!--<button type="button" class="btn btn-info" style="margin-left:50%;">确定</button>-->
							<button type="button" class="btn btn-info" style="margin-left:10px;" onclick="getHabit()">新增</button>
							<select id="range" onchange="getitem('切换')" class="selectpicker show-tick form-control" data-live-search="true" data-actions-box="true">
								<option value="1">未对账</option>
								<option value="3">全部</option>
								<option value="2">已对账</option>
							</select>
						</form>

						<div id="table_main_item" style="max-height:300px;overflow-x:auto;overflow-y:auto;">
							<table id="items" class="table table-striped table-bordered table-condensed table-hover" style="max-width:2000px;">
								<tr>
									<th style="width:10px">选中</th>
									<th>编码</th>
									<th>名称</th>
									<th>型号</th>
									<th>客户编码</th>
									<th>客户型号</th>
									<th>销售单位</th>
									<th>数量</th>
									<th>销售价格</th>
									<th>采购价格</th>
									<th>默认客户</th>
									<th>默认仓库</th>
									<th>负责人</th>
								</tr>
							</table>
						</div>
						<center>
							<a href="#" onclick="getitem('first')">首页</a>
							<a href="#" onclick="getitem('previous')">上一页</a>
							<span id="nowpage">1</span>
							<a href="#" onclick="getitem('next')">下一页</a>
							<a href="#" onclick="getitem('last')">尾页</a>
							[<span id="startpage"></span>/<span id="pagecount"></span>]
							共<span id="countTatol"></span>条
							<select id="pagesize" onchange="getitem(0)" class="selectpicker" data-live-search="true" data-actions-box="true">
								<option value="10">10</option>
								<option value="20">20</option>
								<option value="50">50</option>
								<option value="80">80</option>
							</select>
						</center>
						
					</div>
				</div>
				
			</div>
		</div>
	</div>

<!-- 模态框声明 批量仓库 -->
<div class="modal fade" id="ModalBatchStock" style="height:600px;">
    <!-- 窗口声明 -->
    <div class="modal-dialog" style="width:50%;">
        <!-- 内容声明 -->
        <div class="modal-content">

            <div class="modal-header" style="height:50px;">
                <button class="close" data-dismiss="modal"><span>&times;</span></button>
                <h4 class="modal-title">
					批量选择仓库
                </h4>
            </div>
            <div class="modal-body">
                <div class="container-fluid">

                    <form class="form-inline">
						<h5>
							确定将第
							<select id="nowstock" class="selectpicker show-tick form-control form-control-lg" data-live-search="true" data-actions-box="true">
							</select>
							行的仓库复制到
							<select id="startstock" class="selectpicker show-tick form-control form-control-lg" data-live-search="true" data-actions-box="true">
							</select>
							至
							<select id="endstock" class="selectpicker show-tick form-control form-control-lg" data-live-search="true" data-actions-box="true">
							</select>
							行嘛？
						</h5>
					</form>
					<button style="float: right;" type="button" onclick="batchStock()" class="btn btn-info">确定</button>
                </div>
            </div>

        </div>
    </div>
</div>


<link href="/erp/style/DatePicker2/css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css" />
<script src="/erp/style/DatePicker2/js/bootstrap-datetimepicker.min.js"></script>
<script src="/erp/style/DatePicker2/js/bootstrap-datetimepicker.zh-CN.js"></script>
<script type="text/javascript">
	//选择后端item table
	window.onload = function(){
		var clientHeight = document.body.clientHeight-290;//可用页面高度-90(top84-底部预留6)
		document.getElementById("table_main").style.maxHeight = clientHeight+"px";
	}

	//table 列框拉动改变列宽
	var tTD;
	var table = document.getElementById("mainTable");
	console.log(table.rows[0].cells)
	for (i = 0; i < table.rows[0].cells.length; i++) {
		table.rows[0].cells[i].onmousedown = function() {
			tTD = this;
			if (event.offsetX > tTD.offsetWidth - 10) {
				tTD.mouseDown = true;
				tTD.oldX = event.x;
				tTD.oldWidth = tTD.offsetWidth;
			}
		};
		table.rows[0].cells[i].onmouseup = function() {
			if (tTD == undefined) tTD = this;
			tTD.mouseDown = false;
			tTD.style.cursor = 'default';
		};
		table.rows[0].cells[i].onmousemove = function() {
			if (event.offsetX > this.offsetWidth - 10)
				this.style.cursor = 'col-resize';
			else
				this.style.cursor = 'default';
			if (tTD == undefined) tTD = this;
			if (tTD.mouseDown != null && tTD.mouseDown == true) {
				tTD.style.cursor = 'default';
				if (tTD.oldWidth + (event.x - tTD.oldX) > 0)
					tTD.width = tTD.oldWidth + (event.x - tTD.oldX);
				tTD.style.width = tTD.width;
				tTD.style.cursor = 'col-resize';
				table = tTD;
				while (table.tagName != 'TABLE') table = table.parentElement;
				for (j = 0; j < table.rows.length; j++) {
					table.rows[j].cells[tTD.cellIndex].width = tTD.width;
				}
			}
		};
	}

	//加载默认隐藏扩展
	$("#open").hide();

	$('.form_datetime').datetimepicker({
		language : 'zh-CN',
		format : 'yyyy-mm-dd hh:ii:ss',//日期格式
		weekStart: 1,
		todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		forceParse: 0,
		showMeridian: 1
	});
	$('.form_date').datetimepicker({
		language : 'zh-CN',
		format : 'yyyy-mm-dd',//日期格式
		weekStart: 1,
		todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 2,
		minView: 2,
		forceParse: 0
	});
	$('.form_date_yearmonth').datetimepicker({
		language : 'zh-CN',
		format : 'yyyy-mm',//日期格式
		weekStart: 1,
		todayBtn:  1,
		autoclose: 1,
		todayHighlight: 1,
		startView: 3,
		minView: 3,
		forceParse: 0
	});
	$('.form_time').datetimepicker({
		language : 'zh-CN',
		format : 'hh:ii',//日期格式
		weekStart: 1,//一周的开始 1 星期一 0星期天
		todayBtn:  1,//是否显示'today'按钮
		autoclose: 1,//是否自动关闭日期选择器
		todayHighlight: 1,//当天日期高亮
		//选择 年月日时分 43210
		startView: 1,//首先显示的视图
		minView: 0,//最精确的时间选择视图
		maxView: 1,

		forceParse: 0//强制解析
	});
	</script>

<!--table 列框拉动改变列宽  来源items-->
<script type="text/javascript">
	//table 列框拉动改变列宽 来源items
	var tTD;
	var table = document.getElementById("items");
	console.log(table.rows[0].cells);
	for (i = 0; i < table.rows[0].cells.length; i++) {
		table.rows[0].cells[i].onmousedown = function() {
			tTD = this;
			if (event.offsetX > tTD.offsetWidth - 10) {
				tTD.mouseDown = true;
				tTD.oldX = event.x;
				tTD.oldWidth = tTD.offsetWidth;
			}
		};
		table.rows[0].cells[i].onmouseup = function() {
			if (tTD == undefined) tTD = this;
			tTD.mouseDown = false;
			tTD.style.cursor = 'default';
		};
		table.rows[0].cells[i].onmousemove = function() {
			if (event.offsetX > this.offsetWidth - 10)
				this.style.cursor = 'col-resize';
			else
				this.style.cursor = 'default';
			if (tTD == undefined) tTD = this;
			if (tTD.mouseDown != null && tTD.mouseDown == true) {
				tTD.style.cursor = 'default';
				if (tTD.oldWidth + (event.x - tTD.oldX) > 0)
					tTD.width = tTD.oldWidth + (event.x - tTD.oldX);
				tTD.style.width = tTD.width;
				tTD.style.cursor = 'col-resize';
				table = tTD;
				while (table.tagName != 'TABLE') table = table.parentElement;
				for (j = 0; j < table.rows.length; j++) {
					table.rows[j].cells[tTD.cellIndex].width = tTD.width;
				}
			}
		};
	}

</script>

</body>
</html>